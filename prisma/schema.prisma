// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
}
// ============================================
// HOTEL MANAGEMENT SYSTEM - PRISMA SCHEMA
// ============================================
// Database: PostgreSQL 16+
// Version: 1.0.0
// Features: Multi-tenancy, RBAC, Audit, Soft Deletes
// ============================================


// ============================================
// ENUMS
// ============================================

enum OrganizationType {
  CHAIN
  INDEPENDENT

  @@map("organization_type")
}

enum SubscriptionTier {
  TRIAL
  BASIC
  PRO
  ENTERPRISE

  @@map("subscription_tier")
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED

  @@map("subscription_status")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION

  @@map("user_status")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  SEASONAL

  @@map("employment_type")
}

enum PropertyType {
  HOTEL
  RESORT
  MOTEL
  HOSTEL
  APARTMENT
  VILLA
  BNB

  @@map("property_type")
}

enum HotelStatus {
  ACTIVE
  INACTIVE
  UNDER_CONSTRUCTION
  MAINTENANCE
  CLOSED

  @@map("hotel_status")
}

enum AuditRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("audit_risk_level")
}

// ============================================
// CORE: ORGANIZATIONS (Multi-tenancy root)
// ============================================

model Organization {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code String @db.VarChar(50)
  name String @db.VarChar(255)

  // Legal & Contact
  legalName String  @map("legal_name") @db.VarChar(255)
  taxId     String? @map("tax_id") @db.VarChar(100)
  email     String  @db.VarChar(255)
  phone     String? @db.VarChar(50)
  website   String? @db.VarChar(255)
  logoUrl   String? @map("logo_url") @db.Text

  // Classification
  organizationType OrganizationType @default(INDEPENDENT) @map("organization_type")

  // Subscription & Limits
  subscriptionTier      SubscriptionTier   @default(TRIAL) @map("subscription_tier")
  subscriptionStatus    SubscriptionStatus @default(ACTIVE) @map("subscription_status")
  subscriptionStartDate DateTime?          @map("subscription_start_date") @db.Timestamptz(6)
  subscriptionEndDate   DateTime?          @map("subscription_end_date") @db.Timestamptz(6)
  maxHotels             Int                @default(1) @map("max_hotels")
  maxRooms              Int                @default(50) @map("max_rooms")
  maxUsers              Int                @default(10) @map("max_users")

  // Settings (JSONB)
  enabledFeatures Json @default("[]") @map("enabled_features") @db.JsonB // string[]
  settings        Json @default("{}") @map("settings") @db.JsonB

  // Audit fields (standard pattern)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  version   Int       @default(1)

  // Relations
  hotels     Hotel[]
  users      User[]
  roles      Role[]
  userRoles  UserRole[] // ðŸ”´ FIX #2: Direct relation
  auditLogs  AuditLog[]

  @@unique([code], name: "uq_org_code", map: "uq_org_code") // Partial index handled in migration
  @@index([subscriptionStatus], name: "idx_org_subscription_status")
  @@index([createdAt(sort: Desc)], name: "idx_org_created_at")
  @@map("organizations")
}

// ============================================
// CORE: HOTELS (Properties)
// ============================================

model Hotel {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  code           String @db.VarChar(50)
  name           String @db.VarChar(255)

  // Legal & Branding
  legalName String? @map("legal_name") @db.VarChar(255)
  brand     String? @db.VarChar(100)

  // Classification
  starRating   Decimal?     @map("star_rating") @db.Decimal(2, 1)
  propertyType PropertyType @default(HOTEL) @map("property_type")

  // Contact
  email   String  @db.VarChar(255)
  phone   String  @db.VarChar(50)
  fax     String? @db.VarChar(50)
  website String? @db.VarChar(255)

  // Address
  addressLine1 String  @map("address_line1") @db.VarChar(255)
  addressLine2 String? @map("address_line2") @db.VarChar(255)
  city         String  @db.VarChar(100)
  stateProvince String? @map("state_province") @db.VarChar(100)
  postalCode   String  @map("postal_code") @db.VarChar(20)
  countryCode  String  @map("country_code") @db.Char(2)

  // Geolocation
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  timezone  String   @default("UTC") @db.VarChar(50)

  // Operational Settings
  checkInTime     DateTime @default(dbgenerated("'15:00:00'::time")) @map("check_in_time") @db.Time(6)
  checkOutTime    DateTime @default(dbgenerated("'11:00:00'::time")) @map("check_out_time") @db.Time(6)
  currencyCode    String   @default("USD") @map("currency_code") @db.Char(3)
  defaultLanguage String   @default("en") @map("default_language") @db.Char(2)

  // Capacity
  totalRooms  Int  @default(0) @map("total_rooms")
  totalFloors Int? @map("total_floors")

  // Configuration (JSONB)
  operationalSettings Json @default("{}") @map("operational_settings") @db.JsonB
  amenities           Json @default("[]") @map("amenities") @db.JsonB // string[]
  policies            Json @default("{}") @map("policies") @db.JsonB

  // Status & Dates
  status      HotelStatus @default(ACTIVE)
  openingDate DateTime?   @map("opening_date") @db.Date
  closingDate DateTime?   @map("closing_date") @db.Date

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  version   Int       @default(1)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  userRoles    UserRole[]
  auditLogs    AuditLog[]

  @@unique([organizationId, code], name: "uq_hotel_org_code") // Partial index in migration
  @@index([organizationId], name: "idx_hotel_org")
  @@index([status], name: "idx_hotel_status")
  @@index([countryCode], name: "idx_hotel_country")
  // Note: GIST index for geolocation handled in raw SQL migration
  @@map("hotels")
}

// ============================================
// CORE: USERS
// ============================================

model User {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  email          String  @db.VarChar(255)
  emailVerified  Boolean @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz(6)

  // Authentication
  phone           String?   @db.VarChar(50)
  phoneVerified   Boolean   @default(false) @map("phone_verified")
  phoneVerifiedAt DateTime? @map("phone_verified_at") @db.Timestamptz(6)
  passwordHash    String    @map("password_hash") @db.VarChar(255)

  // Profile
  firstName   String  @map("first_name") @db.VarChar(100)
  lastName    String  @map("last_name") @db.VarChar(100)
  middleName  String? @map("middle_name") @db.VarChar(100)
  displayName String? @map("display_name") @db.VarChar(200)
  avatarUrl   String? @map("avatar_url") @db.Text
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  gender      String? @db.VarChar(20)

  // Employment
  employeeId     String?          @map("employee_id") @db.VarChar(50)
  employmentType EmploymentType?  @map("employment_type")
  department     String?          @db.VarChar(100)
  jobTitle       String?          @map("job_title") @db.VarChar(100)
  hireDate       DateTime?        @map("hire_date") @db.Date
  terminationDate DateTime?       @map("termination_date") @db.Date
  managerId      String?          @map("manager_id") @db.Uuid

  // Security
  passwordChangedAt    DateTime? @map("password_changed_at") @db.Timestamptz(6)
  passwordResetToken   String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpires DateTime? @map("password_reset_expires") @db.Timestamptz(6)
  failedLoginAttempts  Int       @default(0) @map("failed_login_attempts")
  lockedUntil          DateTime? @map("locked_until") @db.Timestamptz(6)
  lastLoginAt          DateTime? @map("last_login_at") @db.Timestamptz(6)
  lastLoginIp          String?   @map("last_login_ip") @db.Inet

  // MFA
  mfaEnabled     Boolean @default(false) @map("mfa_enabled")
  mfaSecret      String? @map("mfa_secret") @db.VarChar(255)
  mfaBackupCodes Json?   @map("mfa_backup_codes") @db.JsonB // string[] (hashed)

  isSuperAdmin Boolean @default(false) @map("is_super_admin")

  // Preferences
  languageCode String @default("en") @map("language_code") @db.Char(2)
  timezone     String @default("UTC") @db.VarChar(50)
  preferences  Json   @default("{}") @db.JsonB

  // Status
  status UserStatus @default(PENDING_VERIFICATION)

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  version   Int       @default(1)

  // Relations
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  manager        User?          @relation("UserManager", fields: [managerId], references: [id])
  subordinates   User[]         @relation("UserManager")
  refreshTokens  RefreshToken[]
  userRoles      UserRole[]
  rolesGranted   UserRole[]     @relation("RoleGrantedBy")
  auditLogs      AuditLog[]

  @@unique([organizationId, email], name: "uq_user_email_org") // Case-insensitive in migration
  @@index([organizationId], name: "idx_user_org")
  @@index([employeeId, organizationId], name: "idx_user_employee_id")
  @@index([status], name: "idx_user_status")
  @@index([isSuperAdmin], name: "idx_user_super_admin")
  @@map("users")
}

// ============================================
// AUTH: REFRESH TOKENS
// ============================================

model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)

  // Lifecycle
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  replacedById String?   @map("replaced_by_id") @db.Uuid

  // Context
  ipAddress       String? @map("ip_address") @db.Inet
  userAgent       String? @map("user_agent") @db.Text
  deviceFingerprint String? @map("device_fingerprint") @db.VarChar(255)
  deviceName      String? @map("device_name") @db.VarChar(100)

  // Metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedBy  RefreshToken? @relation("TokenRotation", fields: [replacedById], references: [id])
  replacements RefreshToken[] @relation("TokenRotation")

  //  Uniqueness per user, not global
  @@unique([userId, tokenHash], name: "uq_refresh_token_user_hash")
  @@index([userId, expiresAt(sort: Desc)], name: "idx_refresh_token_user")
  @@index([expiresAt], name: "idx_refresh_token_expires")
  @@index([userId, deviceFingerprint], name: "idx_refresh_token_device")
  @@map("refresh_tokens")
}

// ============================================
// RBAC: ROLES
// ============================================

model Role {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  code           String @db.VarChar(100)
  name           String @db.VarChar(100)
  description    String? @db.Text

  // Metadata
  isSystem Boolean @default(false) @map("is_system")
  level    Int     @default(0) // Hierarchy: SUPER_ADMIN=100, ORG_ADMIN=90, etc.

  // Configuration
  settings Json @default("{}") @db.JsonB

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions     RolePermission[]
  userRoles       UserRole[]

  @@unique([organizationId, code], name: "uq_role_org_code") // Partial index in migration
  @@index([organizationId], name: "idx_role_org")
  @@index([isSystem, organizationId], name: "idx_role_system")
  @@map("roles")
}

// ============================================
// RBAC: PERMISSIONS
// ============================================

model Permission {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  
  // Single source of truth
  code String @unique @db.VarChar(100) // Format: "RESOURCE.ACTION" (e.g., "RESERVATION.CREATE")

  // Metadata
  displayName String  @map("display_name") @db.VarChar(200)
  description String? @db.Text
  category    String? @db.VarChar(50) // Groups: 'BOOKING', 'FINANCE', 'OPERATIONS'

  // System flag
  isSystem Boolean @default(true) @map("is_system")

  // Audit
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  roles RolePermission[]

  @@index([category], name: "idx_permission_category")
  @@map("permissions")
}

// ============================================
// RBAC: ROLE PERMISSIONS (Many-to-Many)
// ============================================

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  // Metadata
  grantedAt DateTime @default(now()) @map("granted_at") @db.Timestamptz(6)
  grantedBy String?  @map("granted_by") @db.Uuid

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId], name: "idx_role_perm_role")
  @@index([permissionId], name: "idx_role_perm_permission")
  @@map("role_permissions")
}

// ============================================
// RBAC: USER ROLES (Assignment)
// ============================================

model UserRole {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String  @map("user_id") @db.Uuid
  roleId         String  @map("role_id") @db.Uuid
  
  // Direct organization reference for fast permission resolution
  organizationId String  @map("organization_id") @db.Uuid
  
  // Scope (NULL = organization-wide, NOT NULL = hotel-specific)
  hotelId        String? @map("hotel_id") @db.Uuid

  // Assignment metadata
  assignedBy String?   @map("assigned_by") @db.Uuid
  assignedAt DateTime  @default(now()) @map("assigned_at") @db.Timestamptz(6)
  expiresAt  DateTime? @map("expires_at") @db.Timestamptz(6)

  // Audit
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  hotel        Hotel?       @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  assignedByUser User?      @relation("RoleGrantedBy", fields: [assignedBy], references: [id])

  @@unique([userId, roleId, hotelId], name: "uq_user_role_hotel")
  @@index([userId], name: "idx_user_roles_user")
  @@index([roleId], name: "idx_user_roles_role")
  @@index([organizationId], name: "idx_user_roles_org") // ðŸ”´ FIX #2
  @@index([hotelId], name: "idx_user_roles_hotel")
  @@index([userId, expiresAt], name: "idx_user_roles_active") // For active role queries
  @@map("user_roles")
}

// ============================================
// AUDIT: AUDIT LOGS (Compliance & Security)
// ============================================

model AuditLog {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  hotelId        String? @map("hotel_id") @db.Uuid

  // Actor
  userId    String? @map("user_id") @db.Uuid
  userEmail String? @map("user_email") @db.VarChar(255)
  userRole  String? @map("user_role") @db.VarChar(100)

  // Action
  action       String  @db.VarChar(100) // LOGIN, RESERVATION_CREATE, INVOICE_VOID
  resourceType String  @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.Uuid

  // Context
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  ipAddress String?  @map("ip_address") @db.Inet
  userAgent String?  @map("user_agent") @db.Text

  // Details
  changes  Json? @db.JsonB // { "before": {...}, "after": {...} }
  metadata Json? @db.JsonB

  // Risk
  riskLevel   AuditRiskLevel @default(LOW) @map("risk_level")
  isSensitive Boolean        @default(false) @map("is_sensitive")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  hotel        Hotel?       @relation(fields: [hotelId], references: [id], onDelete: SetNull)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, timestamp(sort: Desc)], name: "idx_audit_org_time")
  @@index([userId, timestamp(sort: Desc)], name: "idx_audit_user_time")
  @@index([resourceType, resourceId], name: "idx_audit_resource")
  @@index([riskLevel, timestamp(sort: Desc)], name: "idx_audit_risk")
  @@index([action, timestamp(sort: Desc)], name: "idx_audit_action")
  @@map("audit_logs")
}

// ============================================
// VIEWS (For permission checking)
// ============================================

/// View for active user permissions - CACHE THIS in Redis
view VUserPermission {
  userId             String  @map("user_id") @db.Uuid
  organizationId     String  @map("organization_id") @db.Uuid
  hotelId            String? @map("hotel_id") @db.Uuid
  permissionCode     String  @map("permission_code") @db.VarChar(100)
  permissionCategory String? @map("permission_category") @db.VarChar(50)
  roleCode           String  @map("role_code") @db.VarChar(100)
  roleLevel          Int     @map("role_level")

  @@map("v_user_permissions")
}

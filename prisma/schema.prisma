// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
}

// ============================================
// HOTEL MANAGEMENT SYSTEM - PRISMA SCHEMA
// ============================================
// Database: PostgreSQL 16+
// Version: 1.0.0
// Features: Multi-tenancy, RBAC, Audit, Soft Deletes
// ============================================

// ============================================
// RESERVATIONS MODULE
// ============================================

// ============================================
// ENUMS
// ============================================

enum OrganizationType {
  CHAIN
  INDEPENDENT

  @@map("organization_type")
}

enum SubscriptionTier {
  TRIAL
  BASIC
  PRO
  ENTERPRISE

  @@map("subscription_tier")
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED

  @@map("subscription_status")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION

  @@map("user_status")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  SEASONAL

  @@map("employment_type")
}

enum PropertyType {
  HOTEL
  RESORT
  MOTEL
  HOSTEL
  APARTMENT
  VILLA
  BNB

  @@map("property_type")
}

enum HotelStatus {
  ACTIVE
  INACTIVE
  UNDER_CONSTRUCTION
  MAINTENANCE
  CLOSED

  @@map("hotel_status")
}

enum AuditRiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("audit_risk_level")
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
  WAITLIST

  @@map("reservation_status")
}


enum CheckInStatus {
  NOT_CHECKED_IN
  EARLY_CHECK_IN
  CHECKED_IN
  LATE_CHECK_OUT
  CHECKED_OUT

  @@map("check_in_status")
}

enum BookingSource {
  DIRECT_WEB
  DIRECT_PHONE
  DIRECT_WALKIN
  BOOKING_COM
  EXPEDIA
  AIRBNB
  AGODA
  TRIPADVISOR
  CORPORATE
  TRAVEL_AGENT
  METASEARCH

  @@map("booking_source")
}

enum GuaranteeType {
  CREDIT_CARD
  DEPOSIT
  COMPANY_BILL
  TRAVEL_AGENT
  NONE

  @@map("guarantee_type")
}

enum CancellationPolicy {
  FLEXIBLE // 24h free cancellation
  MODERATE // 48h free cancellation  
  STRICT // 72h free cancellation
  NON_REFUNDABLE

  @@map("cancellation_policy")
}



enum GuestType {
  TRANSIENT
  CORPORATE
  GROUP
  CONTRACTUAL
  COMP
  STAFF
  FAMILY_FRIENDS

  @@map("guest_type")
}

enum VIPStatus {
  NONE
  BRONZE
  SILVER
  GOLD
  PLATINUM
  BLACK

  @@map("vip_status")
}


enum RoomReservationStatus {
  RESERVED
  ASSIGNED
  OCCUPIED
  CHECKED_OUT
  NO_SHOW

  @@map("room_reservation_status")
}




enum RoomStatus {
  VACANT_CLEAN
  VACANT_DIRTY
  VACANT_CLEANING
  OCCUPIED_CLEAN
  OCCUPIED_DIRTY
  OCCUPIED_CLEANING
  OUT_OF_ORDER
  RESERVED
  BLOCKED

  @@map("room_status")
}

enum BedType {
  SINGLE
  DOUBLE
  QUEEN
  KING
  TWIN
  BUNK
  SOFA_BED
  CRIB

  @@map("bed_type")
}

enum MaintenanceStatus {
  NONE
  SCHEDULED
  IN_PROGRESS
  URGENT

  @@map("maintenance_status")
}



enum PricingType {
  DAILY
  PACKAGE
  DERIVED
  NEGOTIATED

  @@map("pricing_type")
}

enum MealPlan {
  ROOM_ONLY
  BREAKFAST
  HALF_BOARD
  FULL_BOARD
  ALL_INCLUSIVE

  @@map("meal_plan")
}



enum FolioItemType {
  ROOM_CHARGE
  TAX
  SERVICE_CHARGE
  POS_CHARGE
  MINIBAR
  LAUNDRY
  SPA
  TRANSPORT
  PHONE
  ADJUSTMENT
  DISCOUNT
  PAYMENT
  REFUND
  NO_SHOW_FEE

  @@map("folio_item_type")
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  CHECK
  MOBILE_PAYMENT
  GIFT_CARD
  LOYALTY_POINTS
  DIRECT_BILL
  DEPOSIT

  @@map("payment_method")
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  VOIDED

  @@map("payment_status")
}


enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  OVERDUE
  VOID
  CREDIT_NOTE

  @@map("invoice_status")
}

// ============================================
// HOUSEKEEPING MODULE
// ============================================

enum HousekeepingType {
  CLEANING_DEPARTURE
  CLEANING_STAYOVER
  CLEANING_TOUCHUP
  DEEP_CLEAN
  TURNDOWN_SERVICE
  INSPECTION
  SPECIAL_REQUEST

  @@map("housekeeping_type")
}


enum HousekeepingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  VERIFIED
  ISSUES_REPORTED
  CANCELLED

  @@map("housekeeping_status")
}


enum MaintenanceCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  FURNITURE
  APPLIANCE
  STRUCTURAL
  PAINTING
  CLEANING
  SAFETY
  IT_EQUIPMENT
  OTHER

  @@map("maintenance_category")
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
  EMERGENCY

  @@map("maintenance_priority")
}

enum MaintenanceRequestStatus {
  REPORTED
  ACKNOWLEDGED
  SCHEDULED
  IN_PROGRESS
  PENDING_PARTS
  COMPLETED
  VERIFIED
  CANCELLED

  @@map("maintenance_request_status")
}

enum InventoryCategory {
  ROOM_SUPPLIES
  MINIBAR
  CLEANING
  FANDB
  MAINTENANCE
  OFFICE
  UNIFORM
  MARKETING
  OTHER

  @@map("inventory_category")
}

enum TransactionType {
  PURCHASE
  CONSUMPTION
  ADJUSTMENT
  RETURN
  TRANSFER
  WASTE
  OPENING

  @@map("transaction_type")
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  CLOSED

  @@map("purchase_order_status")
}


enum CommunicationType {
  RESERVATION_CONFIRMATION
  CHECKIN_REMINDER
  CHECKOUT_REMINDER
  MODIFICATION
  CANCELLATION
  WELCOME
  SURVEY
  MARKETING
  ALERT

  @@map("communication_type")
}

enum CommunicationChannel {
  EMAIL
  SMS
  WHATSAPP
  PUSH

  @@map("communication_channel")
}

enum CommunicationStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  OPENED
  FAILED
  BOUNCED

  @@map("communication_status")
}



enum NightAuditStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  ROLLED_BACK

  @@map("night_audit_status")
}


enum POSOrderStatus {
  OPEN
  CLOSED
  PAID
  VOID
  COMPED

  @@map("pos_order_status")
}

// ============================================
// CORE: ORGANIZATIONS (Multi-tenancy root)
// ============================================

model Organization {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code String @db.VarChar(50)
  name String @db.VarChar(255)

  // Legal & Contact
  legalName String  @map("legal_name") @db.VarChar(255)
  taxId     String? @map("tax_id") @db.VarChar(100)
  email     String  @db.VarChar(255)
  phone     String? @db.VarChar(50)
  website   String? @db.VarChar(255)
  logoUrl   String? @map("logo_url") @db.Text

  // Classification
  organizationType OrganizationType @default(INDEPENDENT) @map("organization_type")

  // Subscription & Limits
  subscriptionTier      SubscriptionTier   @default(TRIAL) @map("subscription_tier")
  subscriptionStatus    SubscriptionStatus @default(ACTIVE) @map("subscription_status")
  subscriptionStartDate DateTime?          @map("subscription_start_date") @db.Timestamptz(6)
  subscriptionEndDate   DateTime?          @map("subscription_end_date") @db.Timestamptz(6)
  maxHotels             Int                @default(1) @map("max_hotels")
  maxRooms              Int                @default(50) @map("max_rooms")
  maxUsers              Int                @default(10) @map("max_users")

  // Settings (JSONB)
  enabledFeatures Json @default("[]") @map("enabled_features") @db.JsonB // string[]
  settings        Json @default("{}") @map("settings") @db.JsonB

  // Audit fields (standard pattern)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  version   Int       @default(1)

  // Relations
  hotels    Hotel[]
  users     User[]
  roles     Role[]
  userRoles UserRole[] // ðŸ”´ FIX #2: Direct relation
  auditLogs AuditLog[]

  changeLogs    ChangeLog[]
  syncConflicts SyncConflict[]
  guests        Guest[]
  reservations  Reservation[]
  roomTypes     RoomType[]
  rooms         Room[]
  ratePlans     RatePlan[]

  @@unique([code], name: "uq_org_code", map: "uq_org_code") // Partial index handled in migration
  @@index([subscriptionStatus], name: "idx_org_subscription_status")
  @@index([createdAt(sort: Desc)], name: "idx_org_created_at")
  @@map("organizations")
}

// ============================================
// CORE: HOTELS (Properties)
// ============================================

model Hotel {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  code           String @db.VarChar(50)
  name           String @db.VarChar(255)

  // Legal & Branding
  legalName String? @map("legal_name") @db.VarChar(255)
  brand     String? @db.VarChar(100)

  // Classification
  starRating   Decimal?     @map("star_rating") @db.Decimal(2, 1)
  propertyType PropertyType @default(HOTEL) @map("property_type")

  // Contact
  email   String  @db.VarChar(255)
  phone   String  @db.VarChar(50)
  fax     String? @db.VarChar(50)
  website String? @db.VarChar(255)

  // Address
  addressLine1  String  @map("address_line1") @db.VarChar(255)
  addressLine2  String? @map("address_line2") @db.VarChar(255)
  city          String  @db.VarChar(100)
  stateProvince String? @map("state_province") @db.VarChar(100)
  postalCode    String  @map("postal_code") @db.VarChar(20)
  countryCode   String  @map("country_code") @db.Char(2)

  // Geolocation
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  timezone  String   @default("UTC") @db.VarChar(50)

  // Operational Settings
  checkInTime     DateTime @default(dbgenerated("'15:00:00'::time")) @map("check_in_time") @db.Time(6)
  checkOutTime    DateTime @default(dbgenerated("'11:00:00'::time")) @map("check_out_time") @db.Time(6)
  currencyCode    String   @default("USD") @map("currency_code") @db.Char(3)
  defaultLanguage String   @default("en") @map("default_language") @db.Char(2)

  // Capacity
  totalRooms  Int  @default(0) @map("total_rooms")
  totalFloors Int? @map("total_floors")

  // Configuration (JSONB)
  operationalSettings Json @default("{}") @map("operational_settings") @db.JsonB
  amenities           Json @default("[]") @map("amenities") @db.JsonB // string[]
  policies            Json @default("{}") @map("policies") @db.JsonB

  // Status & Dates
  status      HotelStatus @default(ACTIVE)
  openingDate DateTime?   @map("opening_date") @db.Date
  closingDate DateTime?   @map("closing_date") @db.Date

  // Audit
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy            String?   @map("created_by") @db.Uuid
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy            String?   @map("updated_by") @db.Uuid
  deletedAt            DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy            String?   @map("deleted_by") @db.Uuid
  version              Int       @default(1)
  lastModifiedByDevice String?   @map("last_modified_by_device") @db.VarChar(255)

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  userRoles    UserRole[]
  auditLogs    AuditLog[]
  changeLogs   ChangeLog[]
  guests       Guest[]
  reservations Reservation[]
  roomTypes    RoomType[]
  rooms        Room[]
  ratePlans    RatePlan[]

  @@unique([organizationId, code], name: "uq_hotel_org_code") // Partial index in migration
  @@index([organizationId], name: "idx_hotel_org")
  @@index([status], name: "idx_hotel_status")
  @@index([countryCode], name: "idx_hotel_country")
  // Note: GIST index for geolocation handled in raw SQL migration
  @@map("hotels")
}

// ============================================
// CORE: USERS
// ============================================

model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  email           String    @db.VarChar(255)
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz(6)

  // Authentication
  phone           String?   @db.VarChar(50)
  phoneVerified   Boolean   @default(false) @map("phone_verified")
  phoneVerifiedAt DateTime? @map("phone_verified_at") @db.Timestamptz(6)
  passwordHash    String    @map("password_hash") @db.VarChar(255)

  // Profile
  firstName   String    @map("first_name") @db.VarChar(100)
  lastName    String    @map("last_name") @db.VarChar(100)
  middleName  String?   @map("middle_name") @db.VarChar(100)
  displayName String?   @map("display_name") @db.VarChar(200)
  avatarUrl   String?   @map("avatar_url") @db.Text
  dateOfBirth DateTime? @map("date_of_birth") @db.Date
  gender      String?   @db.VarChar(20)

  // Employment
  employeeId      String?         @map("employee_id") @db.VarChar(50)
  employmentType  EmploymentType? @map("employment_type")
  department      String?         @db.VarChar(100)
  jobTitle        String?         @map("job_title") @db.VarChar(100)
  hireDate        DateTime?       @map("hire_date") @db.Date
  terminationDate DateTime?       @map("termination_date") @db.Date
  managerId       String?         @map("manager_id") @db.Uuid

  // Security
  passwordChangedAt    DateTime? @map("password_changed_at") @db.Timestamptz(6)
  passwordResetToken   String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpires DateTime? @map("password_reset_expires") @db.Timestamptz(6)
  failedLoginAttempts  Int       @default(0) @map("failed_login_attempts")
  lockedUntil          DateTime? @map("locked_until") @db.Timestamptz(6)
  lastLoginAt          DateTime? @map("last_login_at") @db.Timestamptz(6)
  lastLoginIp          String?   @map("last_login_ip") @db.Inet

  // MFA
  mfaEnabled     Boolean @default(false) @map("mfa_enabled")
  mfaSecret      String? @map("mfa_secret") @db.VarChar(255)
  mfaBackupCodes Json?   @map("mfa_backup_codes") @db.JsonB // string[] (hashed)

  isSuperAdmin Boolean @default(false) @map("is_super_admin")

  // Preferences
  languageCode String @default("en") @map("language_code") @db.Char(2)
  timezone     String @default("UTC") @db.VarChar(50)
  preferences  Json   @default("{}") @db.JsonB

  // Status
  status UserStatus @default(PENDING_VERIFICATION)

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid
  version   Int       @default(1)

  // Relations
  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  manager       User?          @relation("UserManager", fields: [managerId], references: [id])
  subordinates  User[]         @relation("UserManager")
  refreshTokens RefreshToken[]
  userRoles     UserRole[]
  rolesGranted  UserRole[]     @relation("RoleGrantedBy")
  auditLogs     AuditLog[]

  syncMetadata      SyncMetadata[]
  changeLogs        ChangeLog[]
  offlineWrites     OfflineWriteQueue[]
  syncConflicts     SyncConflict[]      @relation("ConflictUser")
  resolvedConflicts SyncConflict[]      @relation("ConflictResolver")

  @@unique([organizationId, email], name: "uq_user_email_org") // Case-insensitive in migration
  @@index([organizationId], name: "idx_user_org")
  @@index([employeeId, organizationId], name: "idx_user_employee_id")
  @@index([status], name: "idx_user_status")
  @@index([isSuperAdmin], name: "idx_user_super_admin")
  @@map("users")
}

// ============================================
// AUTH: REFRESH TOKENS
// ============================================

model RefreshToken {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String @map("user_id") @db.Uuid
  tokenHash String @map("token_hash") @db.VarChar(255)

  // Lifecycle
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  revokedAt    DateTime? @map("revoked_at") @db.Timestamptz(6)
  replacedById String?   @map("replaced_by_id") @db.Uuid

  // Context
  ipAddress         String? @map("ip_address") @db.Inet
  userAgent         String? @map("user_agent") @db.Text
  deviceFingerprint String? @map("device_fingerprint") @db.VarChar(255)
  deviceName        String? @map("device_name") @db.VarChar(100)

  // Metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedBy   RefreshToken?  @relation("TokenRotation", fields: [replacedById], references: [id])
  replacements RefreshToken[] @relation("TokenRotation")

  //  Uniqueness per user, not global
  @@unique([userId, tokenHash], name: "uq_refresh_token_user_hash")
  @@index([userId, expiresAt(sort: Desc)], name: "idx_refresh_token_user")
  @@index([expiresAt], name: "idx_refresh_token_expires")
  @@index([userId, deviceFingerprint], name: "idx_refresh_token_device")
  @@map("refresh_tokens")
}

// ============================================
// RBAC: ROLES
// ============================================

model Role {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  code           String  @db.VarChar(100)
  name           String  @db.VarChar(100)
  description    String? @db.Text

  // Metadata
  isSystem Boolean @default(false) @map("is_system")
  level    Int     @default(0) // Hierarchy: SUPER_ADMIN=100, ORG_ADMIN=90, etc.

  // Configuration
  settings Json @default("{}") @db.JsonB

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String?   @map("created_by") @db.Uuid
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy String?   @map("updated_by") @db.Uuid
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)
  deletedBy String?   @map("deleted_by") @db.Uuid

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  permissions  RolePermission[]
  userRoles    UserRole[]

  @@unique([organizationId, code], name: "uq_role_org_code") // Partial index in migration
  @@index([organizationId], name: "idx_role_org")
  @@index([isSystem, organizationId], name: "idx_role_system")
  @@map("roles")
}

// ============================================
// RBAC: PERMISSIONS
// ============================================

model Permission {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Single source of truth
  code String @unique @db.VarChar(100) // Format: "RESOURCE.ACTION" (e.g., "RESERVATION.CREATE")

  // Metadata
  displayName String  @map("display_name") @db.VarChar(200)
  description String? @db.Text
  category    String? @db.VarChar(50) // Groups: 'BOOKING', 'FINANCE', 'OPERATIONS'

  // System flag
  isSystem Boolean @default(true) @map("is_system")

  // Audit
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  roles RolePermission[]

  @@index([category], name: "idx_permission_category")
  @@map("permissions")
}

// ============================================
// RBAC: ROLE PERMISSIONS (Many-to-Many)
// ============================================

model RolePermission {
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  // Metadata
  grantedAt DateTime @default(now()) @map("granted_at") @db.Timestamptz(6)
  grantedBy String?  @map("granted_by") @db.Uuid

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId], name: "idx_role_perm_role")
  @@index([permissionId], name: "idx_role_perm_permission")
  @@map("role_permissions")
}

// ============================================
// RBAC: USER ROLES (Assignment)
// ============================================

model UserRole {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String @map("user_id") @db.Uuid
  roleId String @map("role_id") @db.Uuid

  // Direct organization reference for fast permission resolution
  organizationId String @map("organization_id") @db.Uuid

  // Scope (NULL = organization-wide, NOT NULL = hotel-specific)
  hotelId String? @map("hotel_id") @db.Uuid

  // Assignment metadata
  assignedBy String?   @map("assigned_by") @db.Uuid
  assignedAt DateTime  @default(now()) @map("assigned_at") @db.Timestamptz(6)
  expiresAt  DateTime? @map("expires_at") @db.Timestamptz(6)

  // Audit
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           Role         @relation(fields: [roleId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  hotel          Hotel?       @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  assignedByUser User?        @relation("RoleGrantedBy", fields: [assignedBy], references: [id])

  @@unique([userId, roleId, hotelId], name: "uq_user_role_hotel")
  @@index([userId], name: "idx_user_roles_user")
  @@index([roleId], name: "idx_user_roles_role")
  @@index([organizationId], name: "idx_user_roles_org") // ðŸ”´ FIX #2
  @@index([hotelId], name: "idx_user_roles_hotel")
  @@index([userId, expiresAt], name: "idx_user_roles_active") // For active role queries
  @@map("user_roles")
}

// ============================================
// AUDIT: AUDIT LOGS (Compliance & Security)
// ============================================

model AuditLog {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  hotelId        String? @map("hotel_id") @db.Uuid

  // Actor
  userId    String? @map("user_id") @db.Uuid
  userEmail String? @map("user_email") @db.VarChar(255)
  userRole  String? @map("user_role") @db.VarChar(100)

  // Action
  action       String  @db.VarChar(100) // LOGIN, RESERVATION_CREATE, INVOICE_VOID
  resourceType String  @map("resource_type") @db.VarChar(100)
  resourceId   String? @map("resource_id") @db.Uuid

  // Context
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  ipAddress String?  @map("ip_address") @db.Inet
  userAgent String?  @map("user_agent") @db.Text

  // Details
  changes  Json? @db.JsonB // { "before": {...}, "after": {...} }
  metadata Json? @db.JsonB

  // Risk
  riskLevel   AuditRiskLevel @default(LOW) @map("risk_level")
  isSensitive Boolean        @default(false) @map("is_sensitive")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  hotel        Hotel?       @relation(fields: [hotelId], references: [id], onDelete: SetNull)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, timestamp(sort: Desc)], name: "idx_audit_org_time")
  @@index([userId, timestamp(sort: Desc)], name: "idx_audit_user_time")
  @@index([resourceType, resourceId], name: "idx_audit_resource")
  @@index([riskLevel, timestamp(sort: Desc)], name: "idx_audit_risk")
  @@index([action, timestamp(sort: Desc)], name: "idx_audit_action")
  @@map("audit_logs")
}

// ============================================
// VIEWS (For permission checking)
// ============================================

/// View for active user permissions - CACHE THIS in Redis
view VUserPermission {
  userId             String  @map("user_id") @db.Uuid
  organizationId     String  @map("organization_id") @db.Uuid
  hotelId            String? @map("hotel_id") @db.Uuid
  permissionCode     String  @map("permission_code") @db.VarChar(100)
  permissionCategory String? @map("permission_category") @db.VarChar(50)
  roleCode           String  @map("role_code") @db.VarChar(100)
  roleLevel          Int     @map("role_level")

  @@map("v_user_permissions")
}

// ============================================
// OFFLINE SYNC MODELS
// ============================================

model SyncMetadata {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  deviceId        String   @map("device_id") @db.VarChar(255)
  resourceType    String   @map("resource_type") @db.VarChar(100)
  lastSyncedAt    DateTime @default(now()) @map("last_synced_at") @db.Timestamptz(6)
  lastSyncVersion BigInt   @default(0) @map("last_sync_version")

  // Device info
  deviceName     String? @map("device_name") @db.VarChar(200)
  devicePlatform String? @map("device_platform") @db.VarChar(50)
  appVersion     String? @map("app_version") @db.VarChar(50)

  // Status
  syncStatus  String    @default("IDLE") @map("sync_status") @db.VarChar(50)
  lastError   String?   @map("last_error") @db.Text
  lastErrorAt DateTime? @map("last_error_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId, resourceType], name: "uq_user_device_resource")
  @@index([userId, deviceId], name: "idx_sync_meta_user_device")
  @@index([resourceType, lastSyncedAt], name: "idx_sync_meta_resource")
  @@map("sync_metadata")
}

model ChangeLog {
  id            String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  globalVersion BigInt @default(autoincrement()) @map("global_version")

  // What changed
  organizationId String  @map("organization_id") @db.Uuid
  hotelId        String? @map("hotel_id") @db.Uuid
  resourceType   String  @map("resource_type") @db.VarChar(100)
  resourceId     String  @map("resource_id") @db.Uuid
  operation      String  @db.VarChar(20) // CREATE, UPDATE, DELETE

  // Who changed it
  userId String? @map("user_id") @db.Uuid

  // When
  timestamp DateTime @default(now()) @db.Timestamptz(6)

  // Payload
  payload Json @db.JsonB

  // Client tracking
  clientId        String?   @map("client_id") @db.VarChar(255)
  clientTimestamp DateTime? @map("client_timestamp") @db.Timestamptz(6)

  // Metadata
  metadata Json @default("{}") @db.JsonB

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  hotel        Hotel?       @relation(fields: [hotelId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([globalVersion], name: "idx_change_log_version")
  @@index([organizationId, globalVersion], name: "idx_change_log_org_version")
  @@index([resourceType, resourceId], name: "idx_change_log_resource")
  @@index([timestamp(sort: Desc)], name: "idx_change_log_timestamp")
  @@map("change_log")
}

model OfflineWriteQueue {
  id              String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String @map("user_id") @db.Uuid
  deviceId        String @map("device_id") @db.VarChar(255)
  clientRequestId String @map("client_request_id") @db.Uuid

  // Command
  operation      String  @map("operation") @db.VarChar(50)
  resourceType   String  @map("resource_type") @db.VarChar(100)
  resourceId     String? @map("resource_id") @db.Uuid
  commandPayload Json    @map("command_payload") @db.JsonB

  // Timing
  clientTimestamp DateTime  @map("client_timestamp") @db.Timestamptz(6)
  receivedAt      DateTime  @default(now()) @map("received_at") @db.Timestamptz(6)
  processedAt     DateTime? @map("processed_at") @db.Timestamptz(6)

  // Status
  status             String  @default("PENDING") @db.VarChar(50)
  errorMessage       String? @map("error_message") @db.Text
  conflictResolution Json?   @map("conflict_resolution") @db.JsonB

  // Result
  serverResourceId String? @map("server_resource_id") @db.Uuid
  serverVersion    Int?    @map("server_version")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, clientRequestId], name: "uq_client_request_id")
  @@index([userId, status], name: "idx_offline_queue_user")
  @@index([deviceId, status], name: "idx_offline_queue_device")
  @@index([status, receivedAt], name: "idx_offline_queue_status")
  @@map("offline_write_queue")
}

model SyncConflict {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  resourceType   String  @map("resource_type") @db.VarChar(100)
  resourceId     String  @map("resource_id") @db.Uuid
  userId         String? @map("user_id") @db.Uuid
  deviceId       String? @map("device_id") @db.VarChar(255)

  // Conflict details
  conflictType String @map("conflict_type") @db.VarChar(50)

  // States
  clientState   Json  @map("client_state") @db.JsonB
  serverState   Json  @map("server_state") @db.JsonB
  resolvedState Json? @map("resolved_state") @db.JsonB

  // Resolution
  resolutionStrategy String?   @map("resolution_strategy") @db.VarChar(50)
  resolvedBy         String?   @map("resolved_by") @db.Uuid
  resolvedAt         DateTime? @map("resolved_at") @db.Timestamptz(6)

  detectedAt DateTime @default(now()) @map("detected_at") @db.Timestamptz(6)
  metadata   Json     @default("{}") @db.JsonB

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation("ConflictUser", fields: [userId], references: [id], onDelete: SetNull)
  resolver     User?        @relation("ConflictResolver", fields: [resolvedBy], references: [id], onDelete: SetNull)

  @@index([organizationId, detectedAt(sort: Desc)], name: "idx_conflict_org")
  @@index([resourceType, resourceId], name: "idx_conflict_resource")
  @@map("sync_conflicts")
}



model Guest {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  hotelId        String? @map("hotel_id") @db.Uuid

  // Profile
  firstName    String    @map("first_name") @db.VarChar(100)
  lastName     String    @map("last_name") @db.VarChar(100)
  email        String?   @db.VarChar(255)
  phone        String?   @db.VarChar(50)
  mobile       String?   @db.VarChar(50)
  dateOfBirth  DateTime? @map("date_of_birth") @db.Date
  nationality  String?   @db.Char(2)
  languageCode String    @default("en") @map("language_code") @db.Char(2)

  // Identification (encrypted at application layer)
  idType       String?   @map("id_type") @db.VarChar(50)
  idNumber     String?   @map("id_number") @db.VarChar(255)
  idExpiryDate DateTime? @map("id_expiry_date") @db.Date

  // Address
  addressLine1  String? @map("address_line1") @db.VarChar(255)
  addressLine2  String? @map("address_line2") @db.VarChar(255)
  city          String? @db.VarChar(100)
  stateProvince String? @map("state_province") @db.VarChar(100)
  postalCode    String? @map("postal_code") @db.VarChar(20)
  countryCode   String? @db.Char(2)

  // Classification
  guestType GuestType @default(TRANSIENT) @map("guest_type")
  vipStatus VIPStatus @default(NONE) @map("vip_status")
  vipReason String?   @map("vip_reason") @db.Text

  // Corporate
  companyName  String? @map("company_name") @db.VarChar(255)
  companyTaxId String? @map("company_tax_id") @db.VarChar(100)

  // Preferences
  roomPreferences     Json?   @map("room_preferences") @db.JsonB
  dietaryRequirements String? @map("dietary_requirements") @db.Text
  specialNeeds        String? @map("special_needs") @db.Text

  // History
  totalStays   Int       @default(0) @map("total_stays")
  totalNights  Int       @default(0) @map("total_nights")
  totalRevenue Decimal   @default(0) @map("total_revenue") @db.Decimal(12, 2)
  lastStayDate DateTime? @map("last_stay_date") @db.Date
  averageRate  Decimal   @default(0) @map("average_rate") @db.Decimal(10, 2)

  // Marketing
  marketingConsent Boolean @default(false) @map("marketing_consent")
  emailOptIn       Boolean @default(false) @map("email_opt_in")
  smsOptIn         Boolean @default(false) @map("sms_opt_in")

  // Notes
  internalNotes String? @map("internal_notes") @db.Text
  alertNotes    String? @map("alert_notes") @db.Text // Shows popup at check-in

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id])
  hotel          Hotel?          @relation(fields: [hotelId], references: [id])
  reservations   Reservation[]
  communications Communication[]

  @@unique([organizationId, email], name: "uq_guest_email_org")
  @@index([organizationId, lastName, firstName], name: "idx_guest_name")
  @@index([hotelId, vipStatus], name: "idx_guest_vip")
  @@map("guests")
}



model Reservation {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  guestId        String @map("guest_id") @db.Uuid

  // Booking Reference
  confirmationNumber String  @unique @map("confirmation_number") @db.VarChar(50)
  externalRef        String? @map("external_ref") @db.VarChar(100) // OTA reference

  // Source
  source        BookingSource @default(DIRECT_WEB)
  channelCode   String?       @map("channel_code") @db.VarChar(50)
  agentId       String?       @map("agent_id") @db.Uuid
  corporateCode String?       @map("corporate_code") @db.VarChar(50)

  // Dates
  checkInDate   DateTime  @map("check_in_date") @db.Date
  checkOutDate  DateTime  @map("check_out_date") @db.Date
  arrivalTime   DateTime? @map("arrival_time") @db.Time(6)
  departureTime DateTime? @map("departure_time") @db.Time(6)
  nights        Int

  // Status
  status        ReservationStatus @default(CONFIRMED)
  checkInStatus CheckInStatus     @default(NOT_CHECKED_IN) @map("check_in_status")

  // Guests
  adultCount  Int @default(1) @map("adult_count")
  childCount  Int @default(0) @map("child_count")
  infantCount Int @default(0) @map("infant_count")

  // Financial
  currencyCode   String  @default("USD") @map("currency_code") @db.Char(3)
  totalAmount    Decimal @map("total_amount") @db.Decimal(12, 2)
  taxAmount      Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(12, 2)
  paidAmount     Decimal @default(0) @map("paid_amount") @db.Decimal(12, 2)
  balance        Decimal @default(0) @map("balance") @db.Decimal(12, 2)

  // Rate Details
  ratePlanId    String  @map("rate_plan_id") @db.Uuid
  rateBreakdown Json    @map("rate_breakdown") @db.JsonB // [{date, rate, tax, total}]
  averageRate   Decimal @map("average_rate") @db.Decimal(10, 2)

  // Policies
  cancellationPolicy CancellationPolicy @default(FLEXIBLE) @map("cancellation_policy")
  guaranteeType      GuaranteeType      @map("guarantee_type")
  guaranteeAmount    Decimal?           @map("guarantee_amount") @db.Decimal(10, 2)

  // Payment
  cardToken       String? @map("card_token") @db.VarChar(255) // Encrypted
  cardLastFour    String? @map("card_last_four") @db.Char(4)
  cardExpiryMonth String? @map("card_expiry_month") @db.Char(2)
  cardExpiryYear  String? @map("card_expiry_year") @db.Char(4)
  cardBrand       String? @map("card_brand") @db.VarChar(20)

  // Notes
  guestNotes      String? @map("guest_notes") @db.Text
  specialRequests String? @map("special_requests") @db.Text
  internalNotes   String? @map("internal_notes") @db.Text

  // Cancellation
  cancelledAt        DateTime? @map("cancelled_at") @db.Timestamptz(6)
  cancelledBy        String?   @map("cancelled_by") @db.Uuid
  cancellationReason String?   @map("cancellation_reason") @db.Text
  cancellationFee    Decimal?  @map("cancellation_fee") @db.Decimal(10, 2)
  noShow             Boolean   @default(false) @map("no_show")

  // Metadata
  bookedAt   DateTime @default(now()) @map("booked_at") @db.Timestamptz(6)
  bookedBy   String   @map("booked_by") @db.Uuid
  modifiedAt DateTime @default(now()) @updatedAt @map("modified_at") @db.Timestamptz(6)
  modifiedBy String?  @map("modified_by") @db.Uuid

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization   Organization      @relation(fields: [organizationId], references: [id])
  hotel          Hotel             @relation(fields: [hotelId], references: [id])
  guest          Guest             @relation(fields: [guestId], references: [id])
  rooms          ReservationRoom[]
  folioItems     FolioItem[]
  payments       Payment[]
  invoices       Invoice[]
  communications Communication[]
  ratePlan       RatePlan          @relation(fields: [ratePlanId], references: [id])

  @@index([hotelId, checkInDate, status], name: "idx_res_hotel_dates")
  @@index([hotelId, confirmationNumber], name: "idx_res_confirmation")
  @@index([guestId, checkInDate(sort: Desc)], name: "idx_res_guest")
  @@index([externalRef], name: "idx_res_external")
  @@map("reservations")
}



model ReservationRoom {
  id            String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reservationId String  @map("reservation_id") @db.Uuid
  roomId        String? @map("room_id") @db.Uuid
  roomTypeId    String  @map("room_type_id") @db.Uuid

  // Assignment
  assignedAt DateTime? @map("assigned_at") @db.Timestamptz(6)
  assignedBy String?   @map("assigned_by") @db.Uuid

  // Stay tracking
  checkInAt  DateTime? @map("check_in_at") @db.Timestamptz(6)
  checkOutAt DateTime? @map("check_out_at") @db.Timestamptz(6)

  // Rate for this room
  roomRate   Decimal @map("room_rate") @db.Decimal(10, 2)
  adultCount Int     @default(2) @map("adult_count")
  childCount Int     @default(0) @map("child_count")

  // Status
  status RoomReservationStatus @default(RESERVED) @map("status")

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  room        Room?       @relation(fields: [roomId], references: [id])
  roomType    RoomType    @relation(fields: [roomTypeId], references: [id])

  @@index([reservationId])
  @@index([roomId, checkInAt, checkOutAt], name: "idx_resroom_room_dates")
  @@map("reservation_rooms")
}



// ============================================
// ROOMS & INVENTORY MODULE
// ============================================

model RoomType {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid

  code        String  @db.VarChar(20)
  name        String  @db.VarChar(100)
  description String? @db.Text

  // Capacity
  baseOccupancy Int @default(2) @map("base_occupancy")
  maxOccupancy  Int @default(2) @map("max_occupancy")
  maxAdults     Int @default(2) @map("max_adults")
  maxChildren   Int @default(0) @map("max_children")

  // Physical
  sizeSqm  Decimal?  @map("size_sqm") @db.Decimal(5, 2)
  sizeSqft Decimal?  @map("size_sqft") @db.Decimal(6, 2)
  bedTypes BedType[] @map("bed_types")

  // Features
  amenities String[] @default([]) // WIFI, TV, MINIBAR, SAFE, etc.
  viewType  String?  @map("view_type") @db.VarChar(50)

  // Housekeeping
  defaultCleaningTime Int @default(30) @map("default_cleaning_time") // minutes

  // Media
  images Json[] @default([]) // [{url, caption, order}]

  // Settings
  isActive     Boolean @default(true) @map("is_active")
  isBookable   Boolean @default(true) @map("is_bookable")
  displayOrder Int     @default(0) @map("display_order")

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization Organization    @relation(fields: [organizationId], references: [id])
  hotel        Hotel           @relation(fields: [hotelId], references: [id])
  rooms        Room[]
  ratePlans    RatePlan[]
  inventory    RoomInventory[]
  resRooms     ReservationRoom[]

  @@unique([hotelId, code], name: "uq_roomtype_hotel_code")
  @@index([hotelId, isActive, isBookable], name: "idx_roomtype_active")
  @@map("room_types")
}

model Room {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  roomTypeId     String @map("room_type_id") @db.Uuid

  roomNumber String  @map("room_number") @db.VarChar(20)
  floor      Int?
  building   String? @db.VarChar(50)
  wing       String? @db.VarChar(50)

  // Status
  status       RoomStatus @default(VACANT_CLEAN)
  isOutOfOrder Boolean    @default(false) @map("is_out_of_order")
  oooReason    String?    @map("ooo_reason") @db.Text
  oooFrom      DateTime?  @map("ooo_from") @db.Date
  oooUntil     DateTime?  @map("ooo_until") @db.Date

  // Features
  isSmoking    Boolean @default(false) @map("is_smoking")
  isAccessible Boolean @default(false) @map("is_accessible")
  viewType     String? @db.VarChar(50)

  // Housekeeping
  lastCleanedAt    DateTime? @map("last_cleaned_at") @db.Timestamptz(6)
  cleaningPriority Int       @default(0) @map("cleaning_priority") // 0=normal, 1=high, 2=urgent

  // Maintenance
  maintenanceStatus MaintenanceStatus @default(NONE) @map("maintenance_status")

  // Financial
  rackRate Decimal? @map("rack_rate") @db.Decimal(10, 2)

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization    Organization         @relation(fields: [organizationId], references: [id])
  hotel           Hotel                @relation(fields: [hotelId], references: [id])
  roomType        RoomType             @relation(fields: [roomTypeId], references: [id])
  reservations    ReservationRoom[]
  hkTasks         HousekeepingTask[]
  maintenanceReqs MaintenanceRequest[]

  @@unique([hotelId, roomNumber], name: "uq_room_hotel_number")
  @@index([hotelId, status], name: "idx_room_status")
  @@index([hotelId, roomTypeId, status], name: "idx_room_type_status")
  @@map("rooms")
}



model RoomInventory {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roomTypeId String   @map("room_type_id") @db.Uuid
  date       DateTime @db.Date

  // Availability
  totalRooms Int @map("total_rooms")
  outOfOrder Int @default(0) @map("out_of_order")
  blocked    Int @default(0)
  sold       Int @default(0)
  available  Int

  // Controls
  overbookingLimit  Int     @default(0) @map("overbooking_limit")
  stopSell          Boolean @default(false) @map("stop_sell")
  minStay           Int?    @map("min_stay")
  maxStay           Int?    @map("max_stay")
  closedToArrival   Boolean @default(false) @map("closed_to_arrival")
  closedToDeparture Boolean @default(false) @map("closed_to_departure")

  // Pricing overrides
  rateOverride Decimal? @map("rate_override") @db.Decimal(10, 2)
  reason       String?  @db.VarChar(255)

  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  roomType RoomType @relation(fields: [roomTypeId], references: [id])

  @@unique([roomTypeId, date], name: "uq_inventory_roomtype_date")
  @@index([roomTypeId, date, available], name: "idx_inventory_avail")
  @@map("room_inventory")
}

// ============================================
// RATE & PRICING MODULE
// ============================================



model RatePlan {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  roomTypeId     String @map("room_type_id") @db.Uuid

  code        String  @db.VarChar(50)
  name        String  @db.VarChar(100)
  description String? @db.Text

  // Pricing
  pricingType  PricingType @default(DAILY) @map("pricing_type")
  baseRate     Decimal     @map("base_rate") @db.Decimal(10, 2)
  currencyCode String      @default("USD") @map("currency_code") @db.Char(3)

  // Restrictions
  minAdvanceDays     Int?               @map("min_advance_days")
  maxAdvanceDays     Int?               @map("max_advance_days")
  minStay            Int                @default(1) @map("min_stay")
  maxStay            Int?               @map("max_stay")
  isRefundable       Boolean            @default(true) @map("is_refundable")
  cancellationPolicy CancellationPolicy @default(FLEXIBLE) @map("cancellation_policy")

  // Channels
  isPublic     Boolean  @default(true) @map("is_public")
  channelCodes String[] @default([]) @map("channel_codes")

  // Inclusions
  mealPlan          MealPlan @default(ROOM_ONLY) @map("meal_plan")
  includedAmenities String[] @default([]) @map("included_amenities")

  // Dynamic pricing rules
  pricingRules Json? @map("pricing_rules") @db.JsonB

  // Validity
  isActive   Boolean   @default(true) @map("is_active")
  validFrom  DateTime? @map("valid_from") @db.Date
  validUntil DateTime? @map("valid_until") @db.Date

  // Audit
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id])
  hotel        Hotel          @relation(fields: [hotelId], references: [id])
  roomType     RoomType       @relation(fields: [roomTypeId], references: [id])
  overrides    RateOverride[]
  reservations Reservation[]

  @@unique([hotelId, code], name: "uq_rateplan_hotel_code")
  @@index([hotelId, isActive, validFrom, validUntil], name: "idx_rateplan_valid")
  @@map("rate_plans")
}

model RateOverride {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ratePlanId String   @map("rate_plan_id") @db.Uuid
  date       DateTime @db.Date

  rate     Decimal @db.Decimal(10, 2)
  stopSell Boolean @default(false) @map("stop_sell")
  minStay  Int?    @map("min_stay")
  reason   String? @db.VarChar(255)

  ratePlan RatePlan @relation(fields: [ratePlanId], references: [id], onDelete: Cascade)

  @@unique([ratePlanId, date], name: "uq_rateoverride_plan_date")
  @@map("rate_overrides")
}

// ============================================
// BILLING & FINANCE MODULE
// ============================================

model FolioItem {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  reservationId  String @map("reservation_id") @db.Uuid

  itemType    FolioItemType @map("item_type")
  description String        @db.VarChar(255)
  amount      Decimal       @db.Decimal(10, 2)
  taxAmount   Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  quantity    Int           @default(1)
  unitPrice   Decimal       @map("unit_price") @db.Decimal(10, 2)

  // Accounting
  revenueCode String @map("revenue_code") @db.VarChar(20)
  department  String @db.VarChar(50)

  // Posting
  postedAt   DateTime  @default(now()) @map("posted_at") @db.Timestamptz(6)
  postedBy   String    @map("posted_by") @db.Uuid
  isVoided   Boolean   @default(false) @map("is_voided")
  voidedAt   DateTime? @map("voided_at") @db.Timestamptz(6)
  voidedBy   String?   @map("voided_by") @db.Uuid
  voidReason String?   @map("void_reason") @db.Text

  // Source
  source    String? @db.VarChar(50) // POS, MINIBAR, etc.
  sourceRef String? @map("source_ref") @db.VarChar(100)

  // Night
  businessDate DateTime @map("business_date") @db.Date

  // Relations
  reservation Reservation @relation(fields: [reservationId], references: [id])

  @@index([reservationId, postedAt], name: "idx_folio_res_posted")
  @@index([hotelId, businessDate], name: "idx_folio_hotel_date")
  @@index([itemType, postedAt], name: "idx_folio_type")
  @@map("folio_items")
}

model Payment {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  reservationId  String @map("reservation_id") @db.Uuid

  amount       Decimal       @db.Decimal(10, 2)
  currencyCode String        @default("USD") @map("currency_code") @db.Char(3)
  method       PaymentMethod

  status PaymentStatus @default(PENDING)

  // Card details (tokenized)
  cardLastFour String? @map("card_last_four") @db.Char(4)
  cardBrand    String? @map("card_brand") @db.VarChar(20)

  // Transaction
  transactionId String?   @map("transaction_id") @db.VarChar(100)
  authCode      String?   @map("auth_code") @db.VarChar(50)
  processedAt   DateTime? @map("processed_at") @db.Timestamptz(6)

  // Refund linkage
  parentPaymentId String? @map("parent_payment_id") @db.Uuid
  isRefund        Boolean @default(false) @map("is_refund")

  // Metadata
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String   @map("created_by") @db.Uuid

  reservation Reservation @relation(fields: [reservationId], references: [id])

  @@index([reservationId, createdAt], name: "idx_payment_res")
  @@index([transactionId], name: "idx_payment_trans")
  @@map("payments")
}

model Invoice {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  reservationId  String @map("reservation_id") @db.Uuid

  invoiceNumber String   @unique @map("invoice_number") @db.VarChar(50)
  issueDate     DateTime @default(now()) @map("issue_date") @db.Date
  dueDate       DateTime @map("due_date") @db.Date

  subtotal   Decimal @db.Decimal(10, 2)
  taxTotal   Decimal @map("tax_total") @db.Decimal(10, 2)
  total      Decimal @db.Decimal(10, 2)
  amountPaid Decimal @default(0) @map("amount_paid") @db.Decimal(10, 2)

  status InvoiceStatus @default(OPEN)

  // Billing address
  billToName    String @map("bill_to_name") @db.VarChar(255)
  billToAddress Json   @map("bill_to_address")

  // Document
  documentUrl String? @map("document_url") @db.Text

  sentAt DateTime? @map("sent_at") @db.Timestamptz(6)
  paidAt DateTime? @map("paid_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  reservation Reservation @relation(fields: [reservationId], references: [id])

  @@index([hotelId, issueDate], name: "idx_invoice_hotel_date")
  @@map("invoices")
}



model HousekeepingTask {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  roomId         String @map("room_id") @db.Uuid

  taskType HousekeepingType   @map("task_type")
  status   HousekeepingStatus @default(PENDING)
  priority Int                @default(0) // 0=normal, 1=high, 2=urgent

  // Assignment
  assignedTo String?   @map("assigned_to") @db.Uuid
  assignedAt DateTime? @map("assigned_at") @db.Timestamptz(6)

  // Scheduling
  scheduledFor     DateTime @map("scheduled_for") @db.Date
  estimatedMinutes Int      @default(30) @map("estimated_minutes")

  // Execution
  startedAt   DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  verifiedAt  DateTime? @map("verified_at") @db.Timestamptz(6)
  verifiedBy  String?   @map("verified_by") @db.Uuid

  // Quality
  inspectionScore Int?    @map("inspection_score") // 1-100
  issuesFound     String? @map("issues_found") @db.Text

  // Notes
  notes         String? @db.Text
  guestRequests String? @map("guest_requests") @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String   @map("created_by") @db.Uuid

  room Room @relation(fields: [roomId], references: [id])

  @@index([hotelId, scheduledFor, status], name: "idx_hk_hotel_date_status")
  @@index([assignedTo, status], name: "idx_hk_staff_status")
  @@map("housekeeping_tasks")
}

// ============================================
// MAINTENANCE MODULE
// ============================================


model MaintenanceRequest {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  hotelId        String  @map("hotel_id") @db.Uuid
  roomId         String? @map("room_id") @db.Uuid

  // Classification
  category    MaintenanceCategory
  priority    MaintenancePriority @default(LOW)
  title       String              @db.VarChar(255)
  description String              @db.Text

  // Reporting
  reportedBy     String   @map("reported_by") @db.Uuid
  reportedByType String   @map("reported_by_type") @db.VarChar(20) // STAFF, GUEST, SYSTEM
  reportedAt     DateTime @default(now()) @map("reported_at") @db.Timestamptz(6)

  // Assignment
  assignedTo String?   @map("assigned_to") @db.Uuid
  assignedAt DateTime? @map("assigned_at") @db.Timestamptz(6)

  // Scheduling
  scheduledFor   DateTime? @map("scheduled_for") @db.Timestamptz(6)
  estimatedHours Float?    @map("estimated_hours")

  // Execution
  startedAt   DateTime? @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  resolution  String?   @db.Text

  // Costs
  partsUsed Json?    @map("parts_used") @db.JsonB // [{itemId, qty, cost}]
  laborCost Decimal? @map("labor_cost") @db.Decimal(10, 2)
  partsCost Decimal? @map("parts_cost") @db.Decimal(10, 2)

  // Status
  status MaintenanceRequestStatus @default(REPORTED)

  // Impact
  roomOutOfOrder Boolean   @default(false) @map("room_out_of_order")
  oooUntil       DateTime? @map("ooo_until") @db.Date

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  room Room? @relation(fields: [roomId], references: [id])

  @@index([hotelId, status, priority], name: "idx_maint_hotel_status")
  @@index([roomId, status], name: "idx_maint_room")
  @@map("maintenance_requests")
}

// ============================================
// INVENTORY & PROCUREMENT MODULE
// ============================================



model InventoryItem {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid

  sku         String            @db.VarChar(50)
  name        String            @db.VarChar(255)
  description String?           @db.Text
  category    InventoryCategory

  // Unit management
  unitOfMeasure String @map("unit_of_measure") @db.VarChar(20)
  parLevel      Int    @map("par_level")
  reorderPoint  Int    @map("reorder_point")
  reorderQty    Int    @map("reorder_qty")

  // Stock
  currentStock   Int @default(0) @map("current_stock")
  reservedStock  Int @default(0) @map("reserved_stock")
  availableStock Int @default(0) @map("available_stock")

  // Valuation
  avgUnitCost  Decimal @default(0) @map("avg_unit_cost") @db.Decimal(10, 4)
  lastUnitCost Decimal @default(0) @map("last_unit_cost") @db.Decimal(10, 4)

  // Tracking
  trackExpiry  Boolean @default(false) @map("track_expiry")
  trackBatches Boolean @default(false) @map("track_batches")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  transactions InventoryTransaction[]
  poItems      PurchaseOrderItem[]

  @@unique([hotelId, sku], name: "uq_invitem_hotel_sku")
  @@map("inventory_items")
}

model InventoryTransaction {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  itemId String @map("item_id") @db.Uuid

  type      TransactionType
  quantity  Int // Positive = in, Negative = out
  unitCost  Decimal?        @map("unit_cost") @db.Decimal(10, 4)
  totalCost Decimal?        @map("total_cost") @db.Decimal(10, 2)

  // Reference
  refType String? @map("ref_type") @db.VarChar(50)
  refId   String? @map("ref_id") @db.Uuid

  // Details
  notes       String?  @db.Text
  performedBy String   @map("performed_by") @db.Uuid
  performedAt DateTime @default(now()) @map("performed_at") @db.Timestamptz(6)

  // Batch/expiry
  batchNumber String?   @map("batch_number") @db.VarChar(50)
  expiryDate  DateTime? @map("expiry_date") @db.Date

  item InventoryItem @relation(fields: [itemId], references: [id])

  @@index([itemId, performedAt], name: "idx_invtrans_item_date")
  @@map("inventory_transactions")
}

model Vendor {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid

  code          String  @db.VarChar(50)
  name          String  @db.VarChar(255)
  contactPerson String? @map("contact_person") @db.VarChar(100)
  email         String? @db.VarChar(255)
  phone         String? @db.VarChar(50)
  address       Json?

  // Terms
  paymentTerms String? @map("payment_terms") @db.VarChar(50)
  currencyCode String  @default("USD") @map("currency_code") @db.Char(3)
  taxId        String? @map("tax_id") @db.VarChar(100)

  // Status
  isApproved Boolean @default(false) @map("is_approved")
  isActive   Boolean @default(true) @map("is_active")

  // Performance
  rating        Int? // 1-5
  lastOrderDate DateTime? @map("last_order_date") @db.Date
  totalOrders   Int       @default(0) @map("total_orders")
  totalSpend    Decimal   @default(0) @map("total_spend") @db.Decimal(12, 2)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  purchaseOrders PurchaseOrder[]

  @@unique([hotelId, code], name: "uq_vendor_hotel_code")
  @@map("vendors")
}



model PurchaseOrder {
  id             String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String @map("organization_id") @db.Uuid
  hotelId        String @map("hotel_id") @db.Uuid
  vendorId       String @map("vendor_id") @db.Uuid

  poNumber String              @unique @map("po_number") @db.VarChar(50)
  status   PurchaseOrderStatus @default(DRAFT)

  // Dates
  orderDate        DateTime  @default(now()) @map("order_date") @db.Date
  expectedDelivery DateTime? @map("expected_delivery") @db.Date
  receivedDate     DateTime? @map("received_date") @db.Date

  // Financial
  subtotal     Decimal @db.Decimal(10, 2)
  taxAmount    Decimal @default(0) @map("tax_amount") @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)

  // Approval
  requestedBy String    @map("requested_by") @db.Uuid
  approvedBy  String?   @map("approved_by") @db.Uuid
  approvedAt  DateTime? @map("approved_at") @db.Timestamptz(6)

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  vendor Vendor              @relation(fields: [vendorId], references: [id])
  items  PurchaseOrderItem[]

  @@index([hotelId, status], name: "idx_po_hotel_status")
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id     String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  poId   String @map("po_id") @db.Uuid
  itemId String @map("item_id") @db.Uuid

  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 4)
  totalPrice Decimal @map("total_price") @db.Decimal(10, 2)

  receivedQty Int @default(0) @map("received_qty")

  po   PurchaseOrder @relation(fields: [poId], references: [id], onDelete: Cascade)
  item InventoryItem @relation(fields: [itemId], references: [id])

  @@map("purchase_order_items")
}

// ============================================
// COMMUNICATIONS MODULE
// ============================================


model Communication {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  hotelId        String? @map("hotel_id") @db.Uuid
  guestId        String? @map("guest_id") @db.Uuid
  reservationId  String? @map("reservation_id") @db.Uuid

  type      CommunicationType
  channel   CommunicationChannel
  direction String               @db.VarChar(10) // INBOUND, OUTBOUND

  subject    String? @db.VarChar(255)
  content    String  @db.Text
  templateId String? @map("template_id") @db.Uuid

  status CommunicationStatus @default(PENDING)

  // Delivery tracking
  sentAt      DateTime? @map("sent_at") @db.Timestamptz(6)
  deliveredAt DateTime? @map("delivered_at") @db.Timestamptz(6)
  openedAt    DateTime? @map("opened_at") @db.Timestamptz(6)

  // Addresses
  fromAddress String? @map("from_address") @db.VarChar(255)
  toAddress   String? @map("to_address") @db.VarChar(255)
  externalId  String? @map("external_id") @db.VarChar(100)

  // Metadata
  metadata Json? @db.JsonB

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  guest       Guest?       @relation(fields: [guestId], references: [id])
  reservation Reservation? @relation(fields: [reservationId], references: [id])

  @@index([guestId, createdAt(sort: Desc)], name: "idx_comm_guest")
  @@index([reservationId], name: "idx_comm_res")
  @@map("communications")
}

// ============================================
// NIGHT AUDIT MODULE
// ============================================


model NightAudit {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hotelId String @map("hotel_id") @db.Uuid

  businessDate DateTime @map("business_date") @db.Date

  status      NightAuditStatus @default(PENDING)
  startedAt   DateTime?        @map("started_at") @db.Timestamptz(6)
  completedAt DateTime?        @map("completed_at") @db.Timestamptz(6)
  performedBy String?          @map("performed_by") @db.Uuid

  // Checks
  unbalancedFolios  Int @default(0) @map("unbalanced_folios")
  uncheckedOutRes   Int @default(0) @map("unchecked_out_res")
  pendingCharges    Int @default(0) @map("pending_charges")
  roomDiscrepancies Int @default(0) @map("room_discrepancies")

  // Financial summary
  roomRevenue      Decimal @default(0) @map("room_revenue") @db.Decimal(12, 2)
  otherRevenue     Decimal @default(0) @map("other_revenue") @db.Decimal(12, 2)
  paymentsReceived Decimal @default(0) @map("payments_received") @db.Decimal(12, 2)

  // Actions
  autoPostedCharges Int @default(0) @map("auto_posted_charges")
  noShowsMarked     Int @default(0) @map("no_shows_marked")

  // Errors
  errors Json? @db.JsonB

  notes String? @db.Text

  @@unique([hotelId, businessDate], name: "uq_nightaudit_hotel_date")
  @@map("night_audits")
}

// ============================================
// POS MODULE (Restaurant/Outlets)
// ============================================



model POSOrder {
  id             String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String  @map("organization_id") @db.Uuid
  hotelId        String  @map("hotel_id") @db.Uuid
  reservationId  String? @map("reservation_id") @db.Uuid

  orderNumber String  @unique @map("order_number") @db.VarChar(50)
  outlet      String  @db.VarChar(100) // Restaurant/bar name
  tableNumber String? @map("table_number") @db.VarChar(20)
  roomNumber  String? @map("room_number") @db.VarChar(20)

  status POSOrderStatus @default(OPEN)

  // Financial
  subtotal      Decimal @db.Decimal(10, 2)
  taxTotal      Decimal @map("tax_total") @db.Decimal(10, 2)
  discountTotal Decimal @default(0) @map("discount_total") @db.Decimal(10, 2)
  serviceCharge Decimal @default(0) @map("service_charge") @db.Decimal(10, 2)
  total         Decimal @db.Decimal(10, 2)

  // Payment
  paymentMethod PaymentMethod? @map("payment_method")
  paidAmount    Decimal        @default(0) @map("paid_amount") @db.Decimal(10, 2)

  // Room posting
  postedToRoom    Boolean   @default(false) @map("posted_to_room")
  postedToFolioAt DateTime? @map("posted_to_folio_at") @db.Timestamptz(6)

  // Staff
  serverId  String    @map("server_id") @db.Uuid
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  closedAt  DateTime? @map("closed_at") @db.Timestamptz(6)

  items POSOrderItem[]

  @@index([hotelId, createdAt], name: "idx_pos_hotel_date")
  @@map("pos_orders")
}

model POSOrderItem {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId String @map("order_id") @db.Uuid

  itemName   String  @map("item_name") @db.VarChar(255)
  itemCode   String? @map("item_code") @db.VarChar(50)
  quantity   Int
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(10, 2)

  modifications       String? @db.Text
  specialInstructions String? @map("special_instructions") @db.Text

  isVoided   Boolean @default(false) @map("is_voided")
  voidReason String? @map("void_reason") @db.Text

  order POSOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("pos_order_items")
}

// ============================================
// CHANNEL MANAGER MODULE
// ============================================

model ChannelConnection {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  hotelId String @map("hotel_id") @db.Uuid

  channelCode String  @map("channel_code") @db.VarChar(50)
  channelName String  @map("channel_name") @db.VarChar(100)
  isActive    Boolean @default(false) @map("is_active")

  // Credentials (encrypted)
  apiKey     String? @map("api_key") @db.VarChar(255)
  apiSecret  String? @map("api_secret") @db.VarChar(255)
  propertyId String? @map("property_id") @db.VarChar(100)

  // Mappings
  ratePlanMappings Json @default("[]") @map("rate_plan_mappings") @db.JsonB
  roomMappings     Json @default("[]") @map("room_mappings") @db.JsonB

  // Sync status
  lastSyncAt     DateTime? @map("last_sync_at") @db.Timestamptz(6)
  lastSyncStatus String?   @map("last_sync_status") @db.VarChar(20)
  syncErrors     Int       @default(0) @map("sync_errors")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([hotelId, channelCode], name: "uq_channel_hotel_code")
  @@map("channel_connections")
}

// ============================================
// VIEWS (Performance optimized)
// ============================================

/// View: Current in-house guests with balances
view VInHouseGuest {
  reservationId String   @map("reservation_id") @db.Uuid
  hotelId       String   @map("hotel_id") @db.Uuid
  guestId       String   @map("guest_id") @db.Uuid
  guestName     String   @map("guest_name") @db.VarChar(200)
  roomNumber    String   @map("room_number") @db.VarChar(20)
  checkInDate   DateTime @map("check_in_date") @db.Date
  checkOutDate  DateTime @map("check_out_date") @db.Date
  nights        Int
  balance       Decimal  @db.Decimal(12, 2)
  folioTotal    Decimal  @map("folio_total") @db.Decimal(12, 2)
  paymentTotal  Decimal  @map("payment_total") @db.Decimal(12, 2)
  vipStatus     String   @map("vip_status") @db.VarChar(20)

  @@map("v_in_house_guests")
}

/// View: Room availability summary
view VRoomAvailability {
  hotelId        String   @map("hotel_id") @db.Uuid
  roomTypeId     String   @map("room_type_id") @db.Uuid
  roomTypeCode   String   @map("room_type_code") @db.VarChar(20)
  date           DateTime @db.Date
  totalRooms     Int      @map("total_rooms")
  availableRooms Int      @map("available_rooms")
  occupiedRooms  Int      @map("occupied_rooms")
  oooRooms       Int      @map("ooo_rooms")
  arrivingToday  Int      @map("arriving_today")
  departingToday Int      @map("departing_today")

  @@map("v_room_availability")
}

/// View: Daily revenue summary
view VDailyRevenue {
  hotelId      String   @map("hotel_id") @db.Uuid
  businessDate DateTime @map("business_date") @db.Date
  roomRevenue  Decimal  @map("room_revenue") @db.Decimal(12, 2)
  fnbRevenue   Decimal  @map("fnb_revenue") @db.Decimal(12, 2)
  otherRevenue Decimal  @map("other_revenue") @db.Decimal(12, 2)
  taxTotal     Decimal  @map("tax_total") @db.Decimal(12, 2)
  totalRevenue Decimal  @map("total_revenue") @db.Decimal(12, 2)
  paymentTotal Decimal  @map("payment_total") @db.Decimal(12, 2)

  @@map("v_daily_revenue")
}
